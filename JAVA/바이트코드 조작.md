# ë°”ì´íŠ¸ì½”ë“œ ì¡°ì‘

## ëª¨ìì—ì„œ í† ë¼ë¥¼ êº¼ë‚´ëŠ” ë§ˆìˆ 

- ByteBuddy ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš©
- ì•„ë˜ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë©´ ""ë¥¼ ì¶œë ¥í•˜ê²Œ ëœë‹¤
- ë§ˆìˆ ì½”ë“œë¥¼ ë¨¼ì € ì‹¤í–‰í•˜ê³  ì¶œë ¥ì„ í•˜ë©´ "Rabbit!" ì„ ì¶œë ¥í•˜ê²Œ ëœë‹¤

`ì´ìœ : í´ë˜ìŠ¤ ë¡œë”©ì„ ì´ë¯¸ í•œ ì‹œì ì—ì„œëŠ” ë°”ì´íŠ¸ ì½”ë“œë¥¼ ì¡°ì‘í•´ë„ ì´ë¯¸ ë¡œë“œëœ ì†ŒìŠ¤ê°€ ë™ì‘í•˜ê¸° ë•Œë¬¸`

```java
public class Moja {

	public String pullOut() {
		return "";
	}
}

public class Masulsa {
	public static void main(String[] args) throws IOException {
		// ë§ˆìˆ ì½”ë“œ
		new ByteBuddy().redefine(Moja.class)
		.method(named("pullOut")).intercept(FixedValue.value("Rabbit!"))
		.make().saveIn(new File("C:\\study\\codemodifysample\\codemodifysample\\target\\classes"));
		
		// ì¶œë ¥
		System.out.println(new Moja().pullOut());
}
```

<aside>
ğŸ’¡ ê·¸ëŸ¼ ì–´ë–»ê²Œ í•´ì•¼ ë™ì ìœ¼ë¡œ ì¡°ì‘í•œ ë°”ì´íŠ¸ì½”ë“œë¥¼ ë¡œë”©í•  ìˆ˜ ìˆì„ê¹Œ?

</aside>

### 1. í´ë˜ìŠ¤ ë¡œë”ë¥¼ ì‚¬ìš©í•œë‹¤

`ì•„ë˜ ì½”ë“œì™€ ê°™ì´ í•˜ë©´ í•´ê²°ì´ ëœë‹¤. í•˜ì§€ë§Œ, í´ë˜ìŠ¤ ë¡œë”© ìˆœì„œì— ë„ˆë¬´ ì˜ì¡´ì ì´ë‹¤.`

`ë§Œì•½, ë‹¤ë¥¸ê³³ì—ì„œ ë¨¼ì € Mojaë¥¼ ì½ì—ˆìœ¼ë©´ ì•„ë˜ ì½”ë“œê°€ ì•ˆë¨¹í ê°€ëŠ¥ì„±ì´ ë†’ë‹¤.`

```java
public class Masulsa {
	public static void main(String[] args) throws IOException {
		**ClassLoader classLoader = Masulsa.class.getClassLoader(); // í´ë˜ìŠ¤ë¡œë” ì‚¬ìš©
		TypePool typePool = TypePool.Default.of(classLoader);**

		new ByteBuddy().redefine(typePool.describe("hello.modify.Moja").resolve(),
			ClassFileLocator.ForClassLoader.of(classLoader))
			.method(named("pullOut")).intercept(FixedValue.value("Rabbit!"))
			.make().saveIn(new File("C:\\study\\codemodifysample\\codemodifysample\\target\\classes"));

		System.out.println(new Moja().pullOut());
	}
}
```

### 2. JavaAgent ì‚¬ìš©

- premainì„ ì •ì˜í•œ javaagentë¥¼ ë§Œë“ ë‹¤

```java
public class MasulsaAgent {
	public static void premain(String agentArgs, Instrumentation inst){
		new AgentBuilder.Default()
			.type(ElementMatchers.any())
			.transform(
				(builder,typeDescription, classLoader, javaModule)
					-> builder.method(named("pullOut")
			)
			.intercept(FixedValue.value("Rabbit!"))).installOn(inst);
	}

}
```

- ë‹¤ìŒê³¼ ê°™ì€ í”ŒëŸ¬ê·¸ì¸ì´ í•„ìš”í•˜ë‹¤

```
[pom.xml]

<build>
  <plugins>
    <plugin>
      <groupId>org.apache.maven.plugins</groupId>
      <artifactId>maven-jar-plugin</artifactId>
      <version>3.1.2</version>
      <configuration>
        <archive>
          <index>true</index>
          <manifest>
            <addClasspath>true</addClasspath>
          </manifest>
          <manifestEntries>
            <mode>development</mode>
            <url>${project.url}</url>
            <key>value</key>
            **<Premain-Class>hello.modify.MasulsaAgent</Premain-Class>
            <Can-Redefine-Classes>true</Can-Redefine-Classes>
            <Can-Retransform-Classes>true</Can-Retransform-Classes>**
          </manifestEntries>
        </archive>
      </configuration>
    </plugin>
  </plugins>
</build>
```

- ë§ˆìˆ ì‚¬ ì‹¤í–‰ì‹œ VMì˜µì…˜ìœ¼ë¡œ javaagentë¥¼ ì„¤ì •í•œë‹¤

![Untitled](https://user-images.githubusercontent.com/46228593/142714428-638eaff7-083a-4988-be15-c2d94404d8a2.png)

ìœ„ 1, 2 ë²ˆ ë°©ì‹ëª¨ë‘ ê°€ì¥ ì²˜ìŒ ì‹œë„í–ˆë˜ ë°©ì‹ì²˜ëŸ¼ ì‹¤ì œ ë°”ì´íŠ¸ì½”ë“œë¥¼ ë³€ê²½í•˜ëŠ”ê²Œ ì•„ë‹Œ `ë©”ëª¨ë¦¬ì— ë¡œë”©ëœ ë°”ì´íŠ¸ì½”ë“œë¥¼ ì¡°ì‘í•˜ëŠ” ë°©ì‹`ì´ë‹¤

1ë²ˆê³¼ 2ë²ˆì˜ ì°¨ì´ëŠ” ì‹¤í–‰ë„ì¤‘ ì¡°ì‘í•˜ì—¬ ë¡œë“œ í•˜ëŠëƒ, ì‹¤í–‰ì‹œì ì— ì¡°ì‘í•œ ë°”ì´íŠ¸ì½”ë“œë¥¼ ë¯¸ë¦¬ ë¡œë“œì‹œì¼œ ë†“ëŠëƒì˜ ì°¨ì´ë‹¤