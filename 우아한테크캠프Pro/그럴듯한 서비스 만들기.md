## ì ‘ê·¼í†µì œ
* Bastion ì´ë€, ì„± ì™¸ê³½ì„ ë³´í˜¸í•˜ê¸° ìœ„í•´ ëŒì¶œëœ ë¶€ë¶„ìœ¼ë¡œ ì ìœ¼ë¡œë¶€í„° íš¨ê³¼ì ìœ¼ë¡œ ë°©ì–´í•˜ê¸° ìœ„í•œ ìˆ˜ë‹¨ì…ë‹ˆë‹¤. ì´ë¥¼ ìš°ë¦¬ì˜ ì•„í‚¤í…ì³ì—ë„ ì ìš©í•´ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

* ê°€ë ¹, ìš°ë¦¬ê°€ í„°ë¯¸ë„ì— ì ‘ì†í•˜ê¸° ìœ„í•´ ì‚¬ìš©í•˜ëŠ” 22ë²ˆ í¬íŠ¸ë¥¼ í•œë²ˆ ìƒê°í•´ë³´ì•„ìš”. `22ë²ˆ í¬íŠ¸ì˜ ê²½ìš° ë³´ì•ˆì´ ëš«ë¦°ë‹¤ë©´ ì„œë¹„ìŠ¤ì— ì‹¬ê°í•œ ë¬¸ì œ`ë¥¼ ì¼ìœ¼í‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ë ‡ë‹¤ê³ , ëª¨ë“  ì„œë²„ì— ë™ì¼ ìˆ˜ì¤€ì˜ ë³´ì•ˆì„ ì„¤ì •í•˜ê³ ì í•œë‹¤ë©´, Auto-Scaling ë“± í™•ì¥ì„±ì„ ê³ ë ¤í•œ êµ¬ì„±ê³¼ ë°°ì¹˜ë©ë‹ˆë‹¤. ì´ ê²½ìš° ê´€ë¦¬ í¬ì¸íŠ¸ê°€ ëŠ˜ì–´ë‚˜ê¸°ì— ì¼ë°˜ì ìœ¼ë¡œëŠ” ë³´ì•ˆ ì„¤ì •ì„ ì¼ì • ë¶€ë¶„ì„ í¬ê¸°í•˜ëŠ” ê²°ì •ì„ í•˜ê²Œ ë©ë‹ˆë‹¤. ë§Œì•½ Bastion Serverê°€ ìˆë‹¤ë©´, ì•…ì„± ë£¨íŠ¸í‚·, ëœì„¬ì›¨ì–´ ë“±ìœ¼ë¡œ í”¼í•´ë¥¼ ë³´ë”ë¼ë„ Bastion Serverë§Œ ì¬êµ¬ì„±í•˜ë©´ ë˜ë¯€ë¡œ, ì„œë¹„ìŠ¤ì— ì˜í–¥ì„ ìµœì†Œí™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ì¶”ê°€ì ìœ¼ë¡œ, `ì„œë¹„ìŠ¤ ì •ìƒ íŠ¸ë˜í”½ê³¼ ê´€ë¦¬ììš© íŠ¸ë˜í”½ì„ êµ¬ë¶„`í•  ìˆ˜ ìˆë‹¤ëŠ” ì´ì ì´ ìˆìŠµë‹ˆë‹¤. ê°€ë ¹, ì„œë¹„ìŠ¤ê°€ DDos ê³µê²©ì„ ë°›ì•„ ëŒ€ì—­í­ì„ ëª¨ë‘ ì°¨ì§€í•˜ê³  ìˆë‹¤ë©´ ì¼ë°˜ì ì¸ ë°©ë²•ìœ¼ë¡œ ì„œë¹„ìŠ¤ìš© ì„œë²„ì— ì ‘ì†í•˜ê¸°ëŠ” ì–´ë µê¸° ë•Œë¬¸ì— ë³„ë„ì˜ ê²½ë¡œë¥¼ í™•ë³´í•´ë‘˜ í•„ìš”ê°€ ìˆìŠµë‹ˆë‹¤. <br><br>ë”°ë¼ì„œ, 22ë²ˆ Port ì ‘ì†ì„ Bastion ì„œë²„ì— ì˜¤í”ˆí•˜ê³  ê·¸ ì„œë²„ì— ë³´ì•ˆì„ ì§‘ì¤‘í•˜ëŠ” ê²ƒì´ íš¨ìœ¨ì ì…ë‹ˆë‹¤.


ğŸ“Œ Bastion Serverë¡œ ì‚¬ìš©í•  ë³„ë„ì˜ EC2ë¥¼ ìƒì„±í•˜ê³ , Bastion Serverì—ì„œ ì„œë¹„ìŠ¤ìš© ì„œë²„ì— ssh ì—°ê²°ì„ ì„¤ì •í•´ë´…ì‹œë‹¤.

```sh
## Bastion Serverì—ì„œ ê³µê°œí‚¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
bastion $ ssh-keygen -t rsa
bastion $ cat ~/.ssh/id_rsa.pub

## ì ‘ì†í•˜ë ¤ëŠ” ì„œë¹„ìŠ¤ìš© ì„œë²„ì— í‚¤ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
$ vi ~/.ssh/authorized_keys

## Bastion Serverì—ì„œ ì ‘ì†ì„ í•´ë´…ë‹ˆë‹¤.
bastion $ ssh ubuntu@[ì„œë¹„ìŠ¤ìš© ì„œë²„ IP]
```
ğŸ“Œ Bastion ServerëŠ” ìì‹ ì˜ ê³µì¸ IPì—ì„œë§Œ 22ë²ˆ í¬íŠ¸ë¡œ ì ‘ê·¼ì´ ê°€ëŠ¥í•˜ë„ë¡ Security Groupì„ ì„¤ì •í•©ë‹ˆë‹¤.

ğŸ“Œ ì„œë¹„ìŠ¤ìš© ì„œë²„ì— 22ë²ˆ í¬íŠ¸ë¡œì˜ ì ‘ê·¼ì€ Bastion ì„œë²„ì—ì„œë§Œ ê°€ëŠ¥í•˜ë„ë¡ Security Groupì„ ì„¤ì •í•©ë‹ˆë‹¤.

ğŸ“Œ Bastion ì„œë²„ì—ì„œ ë‹¤ë¥¸ ì„œë²„ì— ì ‘ê·¼ì´ ìš©ì´í•˜ë„ë¡ ë³„ì¹­ì„ ì„¤ì •í•©ë‹ˆë‹¤.

```sh
bastion $ vi /etc/hosts
[ì„œë¹„ìŠ¤ìš©IP]    [ë³„ì¹­]

bastion $ ssh [ë³„ì¹­]
```

### ìœˆë„ìš°ì—ì„œ EC2 ì›ê²© ë¶™ì„ë•Œ pemí‚¤ ê¶Œí•œë¬¸ì œ
```sh
$ chmod 0600 KEY_xxx.pem
```

### ìŠ¤í”„ë§ ì„¤ì •íŒŒì¼ ë‚˜ëˆ„ê¸°
* application-local.properties, application-test.properties, application-prod.properties
* java -jar -Dspring.profiles.active=prod application.jar
* ê¹ƒ ì„œë¸Œëª¨ë“ˆ
  * git submodule add https://github.com/yoonmin-kim/properties-manage ./src/main/resources/config
  * ì„œë¸Œëª¨ë“ˆ ì¸ì¦ì€ í† í°ìœ¼ë¡œë§Œ ê°€ëŠ¥: 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

### letsencryptë¥¼ í™œìš©í•˜ì—¬ ë¬´ë£Œë¡œ TLS ì¸ì¦ì„œ ì„¤ì •, nginx
* ë„ë©”ì¸ ì…ë ¥ë€ì— www. ê¹Œì§€ ë¶™ì—¬ì£¼ë„ë¡ í•œë‹¤
```sh
$ docker run -it --rm --name certbot \
  -v '/etc/letsencrypt:/etc/letsencrypt' \
  -v '/var/lib/letsencrypt:/var/lib/letsencrypt' \
  certbot/certbot certonly -d 'www.yourdomain.com' --manual --preferred-challenges dns --server https://acme-v02.api.letsencrypt.org/directory
```

<img src="./img/38.png">

*  DNSë¥¼ ì„¤ì •í•˜ëŠ” ì‚¬ì´íŠ¸ì—ì„œ DNS TXT ë ˆì½”ë“œë¥¼ ì¶”ê°€í•œ í›„, ì œëŒ€ë¡œ ë°˜ì˜ë˜ì—ˆëŠ”ì§€ dig ëª…ë ¹ì–´ë¡œ í™•ì¸
```sh
$ dig -t txt _acme-challenge.www.yourdomain.com +short
```

* ìƒì„±í•œ ì¸ì¦ì„œë¥¼ í™œìš©í•˜ì—¬ Reverse Proxyì— TLS ì„¤ì •ë¥¼ ì„¤ì •í•œë‹¤. ìš°ì„  ì¸ì¦ì„œë¥¼ í˜„ì¬ ê²½ë¡œë¡œ ì˜®ê¹€.

```sh
$ cp /etc/letsencrypt/live/www.yourdomain.com/fullchain.pem ./
$ cp /etc/letsencrypt/live/www.yourdomain.com/privkey.pem ./
```

* Dockerfile ì„ ì•„ë˜ì™€ ê°™ì´ ìˆ˜ì •
```
FROM nginx

COPY nginx.conf /etc/nginx/nginx.conf 
COPY fullchain.pem /etc/letsencrypt/live/www.yourdomain.com/fullchain.pem
COPY privkey.pem /etc/letsencrypt/live/www.yourdomain.com/privkey.pem
```

* nginx.conf íŒŒì¼ì„ ì•„ë˜ì™€ ê°™ì´ ìˆ˜ì •
```
events {}

http {       
  upstream app {
    server 172.17.0.1:8080;
  }
  
  # Redirect all traffic to HTTPS
  server {
    listen 80;
    return 301 https://$host$request_uri;
  }

  server {
    listen 443 ssl;  
    ssl_certificate /etc/letsencrypt/live/www.yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/www.yourdomain.com/privkey.pem;

    # Disable SSL
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;

    # í†µì‹ ê³¼ì •ì—ì„œ ì‚¬ìš©í•  ì•”í˜¸í™” ì•Œê³ ë¦¬ì¦˜
    ssl_prefer_server_ciphers on;
    ssl_ciphers ECDH+AESGCM:ECDH+AES256:ECDH+AES128:DH+3DES:!ADH:!AECDH:!MD5;

    # Enable HSTS
    # clientì˜ browserì—ê²Œ httpë¡œ ì–´ë– í•œ ê²ƒë„ load í•˜ì§€ ë§ë¼ê³  ê·œì œí•©ë‹ˆë‹¤.
    # ì´ë¥¼ í†µí•´ httpì—ì„œ httpsë¡œ redirect ë˜ëŠ” requestë¥¼ minimize í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    add_header Strict-Transport-Security "max-age=31536000" always;

    # SSL sessions
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;      

    location / {
      proxy_pass http://app;    
    }
  }
}

```